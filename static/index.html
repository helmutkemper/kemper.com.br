<!DOCTYPE html>
<html>
<header>
    <script src="./js/util/video.js"></script>
    <script src="js/util/monaco_actions_youtube.js"></script>
    <script src="js/util/monaco_actions_code.js"></script>

    <link href="./kendo/examples/content/shared/styles/examples-offline.css" rel="stylesheet">
    <link href="./kendo/styles/kendo.common.min.css" rel="stylesheet">
    <link href="./kendo/styles/kendo.rtl.min.css" rel="stylesheet">
    <link href="./kendo/styles/kendo.default.min.css" rel="stylesheet">
    <link href="./kendo/styles/kendo.default.mobile.min.css" rel="stylesheet">
    <script src="./kendo/js/jquery.min.js"></script>
    <script src="./kendo/js/jszip.min.js"></script>
    <script src="./kendo/js/kendo.all.min.js"></script>
    <script src="./kendo/examples/content/shared/js/console.js"></script>

    <!-- background-color: #5a3030; -->
    <style>
        html, body, #container {
            position: fixed;
            left: 0px;
            top: 41px;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #ffffff;
            z-index: -1;
        }
        .decorBold {
            background-color: #255308;
            cursor: pointer;
            font-weight: normal;
            font-style: oblique;
        }
        .decorNone {
            background-color: transparent;
            cursor: pointer;
            font-weight: normal;
            font-style: oblique;
        }

    </style>
    <style>
        #mediaPlayer {
            min-width: 235px;
            height: 100%;
        }

        .k-prompt-container, .k-window-content {
            padding: 0;
            overflow: hidden;
            position: relative;
            outline: 0;
        }

        #megaStore {
            position: fixed;
            top: 0;
            left: 50px;
            border: 0px;
            margin: 0px auto;
        }

        #menu {background: #ffffff;}
        #menu .k-menu .k-item, .k-menu.k-header {
            border-style: none;
            border-color: #ffffff;
        }
        #menu .k-menu .k-item, .k-menu-scroll-wrapper .k-item, .k-menu-scroll-wrapper.horizontal>.k-item, .k-popups-wrapper .k-item, .k-popups-wrapper.horizontal>.k-item, .k-widget.k-menu-horizontal>.k-item {
            border-style: none;
        }
        .menuWith {
            height: 30px;
        }

        #menu h2 {
            font-size: 1em;
            text-transform: uppercase;
            padding: 0px 10px;
        }
        #template img {
            margin: 0px 20px 0 0;
            float: left;
        }
        #template {
            width: 380px;
        }
        #template ol {
            float: left;
            margin: 0 0 0 30px;
            padding: 10px 10px 0 10px;
        }
        #template:after {
            content: ".";
            display: block;
            height: 0;
            clear: both;
            visibility: hidden;
        }
        #template .k-button {
            float: left;
            clear: left;
            margin: 5px 0 5px 12px;
        }

        .armchair {
            float: left;
            margin: 10px 50px 160px 30px;
            text-align: center;
            vertical-align:middle;
            horiz-align:center;
        }

    </style>
</header>
<body>

<script src="./node_modules/monaco-editor/min/vs/loader.js"></script>

<!-- https://www.youtube.com/embed/5oYfO5qPv44 -->
<!-- iframe id="video" class="video" src="" width="333" height="187" frameborder="0" allowfullscreen="allowfullscreen"></iframe -->

<div id="example">
    <div id="megaStore">
        <ul id="menu">

        </ul>
    </div>
    <div id="window">
        <div class="armchair">
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <img src="./kendo/logos/logo_nova_200.png" alt="Kemper logo" />
            <h3>C é vida;<br>Golang é uma evolução do C!</h3>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>Atualizado em 15/02/2021</p>
        </div>
        <p>&nbsp;</p>
        <p>Meu nome é <b>Helmut Kemper</b> e eu sou desenvolvedor Golang com uns 5 anos de expiencia em Go, além de uma vida de experiência em outras linguagens de programação.</p>
        <p>&nbsp;</p>
        <p>Minha ideia com este projeto é ajudar a comunidade de duas formas:</p>
        <p>&nbsp;</p>
        <p><b>Conversando com o dev</b> - Uma série de vídeos com o intuito de compartilhar minha experiência de programação com quem já programa e discutir uma forma melhor de interagir com o código.</p>
        <p>&nbsp;</p>
        <p><b>Projeto Sérgio Desenvolvedor</b> - Uma tentativa de tornar um Guri muito gente fina (e um péssimo humorista) em um excelente desenvovedor.</p>
        <p>&nbsp;</p>
        <p>Para isto, vamos usar vídeos do youtube sincronizados ccom o <a href="https://github.com/microsoft/monaco-editor">Monaco</a>, editor da Microsoft, em uma tentativa experimental de explicar código usando vídeo com um consumo de banda muito manor.</p>
        <p>&nbsp;</p>
        <p>O projeto é totalmente gratuito, mas, você sempre pode me ajudar a pagar os servidores passando um pix.</p>
    </div>

</div>
<div id="container"></div>
<div id="youtube">
    <div id="mediaPlayer"></div>
</div>

</body>
</html>

<script>
    const videoDataUrl = "./saveTimeLine";
    let oldDecorations = [];
    let editor;
    let selectionData;
    let videoTime = 0;
    let youtubeCode;
    let youtubeActionList = [];

    require.config({ paths: { 'vs': './node_modules/monaco-editor/min/vs' }});
    window.MonacoEnvironment = { getWorkerUrl: () => proxy };

    let proxy = URL.createObjectURL(new Blob([` self.MonacoEnvironment = { baseUrl: './node_modules/monaco-editor/min/' }; `], { type: 'text/javascript' }));

    require(["vs/editor/editor.main"], function () {
        const theme = {
            base: 'vs-dark',
            inherit: true,
            colors: {
                "editor.background": '#222'
            },
            rules: []
        }

        monaco.editor.defineTheme('myTheme', theme)
        editor = monaco.editor.create(document.getElementById('container'), {
            value: [].join('\n'),
            language: 'go',
            theme: 'myTheme'
        });



        // {
        //     "selection": {
        //         "startLineNumber": 9,
        //         "startColumn": 20,
        //         "endLineNumber": 9,
        //         "endColumn": 20,
        //         "selectionStartLineNumber": 9,
        //         "selectionStartColumn": 20,
        //         "positionLineNumber": 9,
        //         "positionColumn": 20
        // },
        //     "secondarySelections": [],
        //     "modelVersionId": 1,
        //     "oldSelections": [
        //     {
        //         "startLineNumber": 12,
        //         "startColumn": 5,
        //         "endLineNumber": 16,
        //         "endColumn": 6,
        //         "selectionStartLineNumber": 12,
        //         "selectionStartColumn": 5,
        //         "positionLineNumber": 16,
        //         "positionColumn": 6
        //     }
        // ],
        //     "oldModelVersionId": 1,
        //     "source": "mouse",
        //     "reason": 3
        // }
        editor.onDidChangeCursorPosition((e) => {
            selectionData = e;
            //console.log(JSON.stringify(e));
        });

        // {
        //     "selection": {
        //         "startLineNumber": 9,
        //         "startColumn": 20,
        //         "endLineNumber": 9,
        //         "endColumn": 20,
        //         "selectionStartLineNumber": 9,
        //         "selectionStartColumn": 20,
        //         "positionLineNumber": 9,
        //         "positionColumn": 20
        // },
        //     "secondarySelections": [],
        //     "modelVersionId": 1,
        //     "oldSelections": [
        //     {
        //         "startLineNumber": 12,
        //         "startColumn": 5,
        //         "endLineNumber": 16,
        //         "endColumn": 6,
        //         "selectionStartLineNumber": 12,
        //         "selectionStartColumn": 5,
        //         "positionLineNumber": 16,
        //         "positionColumn": 6
        //     }
        // ],
        //     "oldModelVersionId": 1,
        //     "source": "mouse",
        //     "reason": 3
        // }
        editor.onDidChangeCursorSelection((e) => {
            selectionData = e;
            //console.log(JSON.stringify(e));
        });

//Register a custom snippet
        monaco.languages.registerCompletionItemProvider('go', {
            provideCompletionItems: () => {
                return [
                    {
                        label: 'for: Array',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        documentation: 'Iterate over an Array',
                        insertText: [
                            'for(let i=0; i < arr.length; i++){',
                            '\tlet elem = arr[i];',
                            '',
                            '}'].join('\n')
                    }
                ]
            }
        });

//Add custom action
        editor.addAction({
            id: 'insert-text-at-cusor-command',
            label: 'Command Snippet',
            keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.F10],
            contextMenuGroupId: 'snippets',
            contextMenuOrder: 1.5,
            run: function (ed) {
                editor.focus()
                editor.trigger('keyboard', 'type', {text: "for"});
            }
        });

        editor.addAction({
            id: "clearCode",
            label: "clear code selector",
            keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_0],
            contextMenuGroupId: "0codeVideoGroup",
            contextMenuOrder: 1.0,
            run: function() {
                let obj = {
                    'action': 'clear',
                    'time': videoTime,
                    'startLineNumber': selectionData.selection.startLineNumber,
                    'startColumn': selectionData.selection.startColumn,
                    'endLineNumber': selectionData.selection.endLineNumber,
                    'endColumn': selectionData.selection.endColumn,
                    'youtubeCode': youtubeCode
                }

                oldDecorations = editor.deltaDecorations(oldDecorations, [{
                    range: new monaco.Range(
                        selectionData.selection.startLineNumber,
                        selectionData.selection.startColumn,
                        selectionData.selection.endLineNumber,
                        selectionData.selection.endColumn
                    ),
                    options: { inlineClassName: 'decorNone' }
                },]);

                appendToYoutubeActionList(obj);
                sendVideoData(obj);
            }
        });

        editor.addAction({
            id: "mediaPlayerFunctionPlay",
            label: "Reproduzir vídeo",
            keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_2],
            contextMenuGroupId: "1videoPlayer",
            contextMenuOrder: 1.0,
            run: function() {
                mediaPlayer.play();
            }
        });

        editor.addAction({
            id: "mediaPlayerFunctionPause",
            label: "Pausar vídeo",
            keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_3],
            contextMenuGroupId: "1videoPlayer",
            contextMenuOrder: 2.0,
            run: function() {
                mediaPlayer.pause();
            }
        });

        editor.addAction({
            id: "mediaPlayerFunctionStop",
            label: "Parar vídeo",
            keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_4],
            contextMenuGroupId: "1videoPlayer",
            contextMenuOrder: 3.0,
            run: function() {
                mediaPlayer.stop();
            }
        });

        editor.addAction({
            id: "mediaPlayerFunctionMute",
            label: "Silenciar vídeo",
            keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_5],
            contextMenuGroupId: "1videoPlayer",
            contextMenuOrder: 4.0,
            run: function() {
                mediaPlayer.mute(!mediaPlayer.mute());
            }
        });

        editor.addAction({
            id: "selectCode",
            label: "set code selector",
            keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_1],
            contextMenuGroupId: "0codeVideoGroup",
            contextMenuOrder: 2.0,
            run: function() {
                let obj = {
                    'action': 'selection',
                    'time': videoTime,
                    'startLineNumber': selectionData.selection.startLineNumber,
                    'startColumn': selectionData.selection.startColumn,
                    'endLineNumber': selectionData.selection.endLineNumber,
                    'endColumn': selectionData.selection.endColumn,
                    'youtubeCode': youtubeCode
                }

                oldDecorations = editor.deltaDecorations(oldDecorations, [{
                    range: new monaco.Range(
                        selectionData.selection.startLineNumber,
                        selectionData.selection.startColumn,
                        selectionData.selection.endLineNumber,
                        selectionData.selection.endColumn
                    ),
                    options: { inlineClassName: 'decorBold' }
                },]);

                appendToYoutubeActionList(obj);
                sendVideoData(obj);
            }
        });




        require.config({ paths: { 'vs': './node_modules/monaco-editor/esm/vs' }});
        let menus = require('vs/platform/actions/common/actions').MenuRegistry._menuItems;

        let contextMenuEntry = [...menus].find(entry => entry[0]._debugName === "EditorContext")
        let contextMenuLinks = contextMenuEntry[1]

        let removableIds = ["editor.action.clipboardCopyAction", "editor.action.clipboardPasteAction", "vs.editor.ICodeEditor:1:clearCode", "vs.editor.ICodeEditor:1:selectCode", "vs.editor.ICodeEditor:1:videoCode"]

        let removeById = (list, ids) => {
            let node = list._first
            do {
                let shouldRemove = ids.includes(node.element?.command?.id)
                if (shouldRemove) { list._remove(node) }
            } while ((node = node.next))
        }

        //removeById(contextMenuLinks, removableIds)

        // Add a content widget (scrolls inline with text)
        var contentWidget = {
            domNode: null,
            getId: function() {
                return 'my.content.widget';
            },
            getDomNode: function() {
                if (!this.domNode) {
                    this.domNode = document.createElement('div');
                    this.domNode.innerHTML = '<img width="100px" height="100px" src="https://placeimg.com/100/100/any" />';
                }
                return this.domNode;
            },
            getPosition: function() {
                return {
                    position: {
                        lineNumber: 17,
                        column: 38
                    },
                    //preference: [monaco.editor.ContentWidgetPositionPreference.ABOVE]
                    preference: [monaco.editor.ContentWidgetPositionPreference.BELOW]
                };
            }
        };
        editor.addContentWidget(contentWidget);



        var output = document.getElementById('output');
        function showEvent(str) {
            while(output.childNodes.length > 6) {
                output.removeChild(output.firstChild.nextSibling.nextSibling);
            }
            output.appendChild(document.createTextNode(str));
            output.appendChild(document.createElement('br'));
        }






















        



/*
        super(nls.localize('quickCommandActionInput', "Type the name of an action you want to execute"), {
            id: 'editor.action.quickCommand',
            label: nls.localize('QuickCommandAction.label', "Command Palette"),
            alias: 'Command Palette',
            precondition: null,
            kbOpts: {
                kbExpr: EditorContextKeys.focus,
                primary: (browser.isIE ? KeyMod.Alt | KeyCode.F1 : KeyCode.F1)
            },
            menuOpts: {
            }
        });
*/

    });

</script>
<script>
    var timeOutVideo;
    var mediaPlayer;
    $(document).ready(function() {
        $("#menu").kendoMenu(
            {
                select: onMenuSelect,
                dataSource: [
                    {
                        text: "Kemper.com.br",
                        spriteCssClass: "menuWith",
                        imageUrl: "./kendo/logos/golang_black.png",
                        items: [
                            {
                                text: "Github",
                                spriteCssClass: "menuWith",
                                url: "https://github.com/helmutkemper",
                                imageUrl: "./kendo/logos/github_log.png"
                            },
                            {
                                text: "LinkedIn",
                                spriteCssClass: "menuWith",
                                url: "https://www.linkedin.com/in/helmut-kemper-93a5441b/",
                                imageUrl: "./kendo/logos/linkedin_logo.png"
                            }
                        ]
                    },
                    {
                        text: "Códigos",
                        spriteCssClass: "menuWith",
                        imageUrl: "./kendo/logos/youtube_logo.png",
                        items: [
                            {
                                text: "Conversando com o dev",
                                imageUrl: "../content/shared/icons/16/star.png",
                                items: [
                                    {
                                        text: "Conversando com o dev",
                                        imageUrl: "../content/shared/icons/16/star.png"
                                    },
                                    {
                                        text: "Sérgio Desenvolvedor",
                                        imageUrl: "../content/shared/icons/16/photo.png"
                                    }
                                ]
                            },
                            {
                                text: "Sérgio Desenvolvedor",
                                imageUrl: "../content/shared/icons/16/photo.png",
                                items: [
                                    {
                                        text: "Hello World"
                                    },
                                    {
                                        text: "Sérgio Desenvolvedor",
                                        imageUrl: "../content/shared/icons/16/photo.png"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        text: "Doação",
                        spriteCssClass: "menuWith",
                        imageUrl: "./kendo/logos/doacao_logo.png",
                    },
                    {
                        text: "Sobre",
                        spriteCssClass: "menuWith",
                        imageUrl: "./kendo/logos/sobre_logo.png",
                    }
                ]}
        );

        var myWindow = $("#window");
        var winYoutube = $("#youtube");

        function onMenuSelect(e) {
            switch ($(e.item).children(".k-link").text()) {
                case "Sobre":
                    myWindow.data("kendoWindow").open().center();
            }
        }

        winYoutube.kendoWindow({
            position: {
                top: "5%",
                left: "70%",
            },
            content: {
                width: "100%",
                height: "100%"
            },
            width: "365px",
            height: "208px",
            title: "Aula",
            visible: false,
            actions: [
                "Maximize",
                "Close"
            ],
            close: function() {
                mediaPlayer.stop();
            }
        }).data("kendoWindow").open();

        myWindow.kendoWindow({
            width: "600px",
            height: "400px",
            title: "Sobre mim",
            visible: false,
            actions: [
                "Close"
            ]
        }).data("kendoWindow").open().center();

        mediaPlayer = $("#mediaPlayer").kendoMediaPlayer({
            autoPlay: true,
            navigatable: false,
            resize: function() {
                console.log(mediaPlayer.width);
                console.log(mediaPlayer.height);
            },
            media: {
                title: "ProgressNEXT 2018 Highlights",
                source: "https://www.youtube.com/watch?v=5oYfO5qPv44"
            }
        }).data("kendoMediaPlayer");



        setInterval(function (){
            let timeHTML = $(".k-mediaplayer-currenttime").text();
            let timeParts = timeHTML.split(":").reverse();

            videoTime = 0;

            for (let i = 0; i < timeParts.length; i++) {
                videoTime = videoTime + (parseInt(timeParts[i]) * Math.pow(60, i));
            }

            if(youtubeActionList.length === 0 ){
                return
            }

            let currentTimeActionId;
            let currentTimeActionInfo = {};
            let pass = false;
            for(let i = 0; i !== youtubeActionList.length; i += 1) {
                currentTimeActionInfo = youtubeActionList[i];
                currentTimeActionId = i;

                if(currentTimeActionInfo.hasOwnProperty('time') === false) {
                    currentTimeActionInfo.time = 0;
                }

                if(currentTimeActionInfo.hasOwnProperty('id') === false) {
                    currentTimeActionInfo.id = 0;
                }

                if(currentTimeActionInfo.time === videoTime) {
                    pass = true
                    break
                }
            }
            if(pass === false) {
                return;
            }
            /*
            let obj = {
                        'id': 0,
                        'action': 'clear',
                        'time': videoTime,
                        'startLineNumber': selectionData.selection.startLineNumber,
                        'startColumn': selectionData.selection.startColumn,
                        'endLineNumber': selectionData.selection.endLineNumber,
                        'endColumn': selectionData.selection.endColumn,
                        'youtubeCode': youtubeCode
                    }
             */

            if(currentTimeActionInfo.action === 'selection') {
                oldDecorations = editor.deltaDecorations(oldDecorations, [{
                    range: new monaco.Range(
                        currentTimeActionInfo.startLineNumber,
                        currentTimeActionInfo.startColumn,
                        currentTimeActionInfo.endLineNumber,
                        currentTimeActionInfo.endColumn
                    ),
                    options: { inlineClassName: 'decorBold' }
                },]);
            }

            if(currentTimeActionInfo.action === 'clear') {
                oldDecorations = editor.deltaDecorations(oldDecorations, [{
                    range: new monaco.Range(
                        currentTimeActionInfo.startLineNumber,
                        currentTimeActionInfo.startColumn,
                        currentTimeActionInfo.endLineNumber,
                        currentTimeActionInfo.endColumn
                    ),
                    options: { inlineClassName: 'decorNone' }
                },]);
            }
        }, 300)


    });
</script>